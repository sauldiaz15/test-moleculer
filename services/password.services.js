const { Service } = require("moleculer");
const nodemailer = require("nodemailer");
const bcrypt = require("bcrypt");
const jwt = require("jsonwebtoken");
require("dotenv").config();

module.exports = {
  name: "password",

  methods: {
    async sendRecoveryEmail(email, resetToken) {
      try {
        if (!email || !resetToken) throw new Error("Email y token son obligatorios.");

        // üåê Enlace Web
        const webResetLink = `https://localhost:3000/ResetPassword?token=${resetToken}`;

        // üì± Deep Link para la app
        const appResetLink = `myapp://ResetPassword?token=${resetToken}`;

        console.log(`üì© Enviando correo de recuperaci√≥n a: ${email}`);

        const transporter = nodemailer.createTransport({
          host: process.env.SMTP_HOST,
          port: process.env.SMTP_PORT,
          secure: false,
          auth: {
            user: process.env.SMTP_USER,
            pass: process.env.SMTP_PASS,
          },
        });

        const mailOptions = {
          from: `"Soporte" <${process.env.SMTP_USER}>`,
          to: email,
          subject: "Recuperaci√≥n de contrase√±a",
          html: `
            <p>Has solicitado restablecer tu contrase√±a.</p>
            <p>Puedes restablecerla desde la aplicaci√≥n o la web:</p>
            <ul>
              <li>üì± <a href="${appResetLink}">Abrir en la aplicaci√≥n</a></li>
              <li>üåê <a href="${webResetLink}">Abrir en la web</a></li>
            </ul>
            <p>El enlace es v√°lido por 15 minutos.</p>
            <p>Si no solicitaste este cambio, ignora este mensaje.</p>
          `,
        };

        await transporter.sendMail(mailOptions);
        console.log(`‚úÖ Correo enviado correctamente a ${email}`);
      } catch (error) {
        console.error("‚ùå Error enviando correo:", error);
        throw new Error("No se pudo enviar el correo de recuperaci√≥n.");
      }
    },
  },

  actions: {
    async forgetPassword(ctx) {
      try {
        const { email } = ctx.params;
        if (!email) throw new Error("El campo email es obligatorio.");

        const user = await ctx.call("user.findByEmail", { email });
        if (!user) throw new Error("Usuario no encontrado.");

        // üîë Generando token de recuperaci√≥n...
        const resetToken = jwt.sign({ email }, process.env.JWT_SECRET, { expiresIn: "15m" });

        await this.sendRecoveryEmail(email, resetToken);

        return { 
          message: "Correo de recuperaci√≥n enviado.", 
          links: {
            app: `myapp://ResetPassword?token=${resetToken}`,
            web: `https://miapp.com/ResetPassword?token=${resetToken}`
          }
        };
      } catch (error) {
        throw new Error("Error al enviar el correo: " + error.message);
      }
    },

    async resetPassword(ctx) {
      try {
        const { token, newPassword } = ctx.params;
        if (!token || !newPassword) throw new Error("Token y nueva contrase√±a son obligatorios.");

        // üîë Verificando token...
        let decoded;
        try {
          decoded = jwt.verify(token, process.env.JWT_SECRET);
        } catch (error) {
          throw new Error("Token inv√°lido o expirado.");
        }

        const email = decoded.email;

        // üîç Buscando usuario en la base de datos...
        const user = await ctx.call("user.findByEmail", { email });
        if (!user) throw new Error("Usuario no encontrado.");

        // üîí Validando contrase√±a...
        if (!/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/.test(newPassword)) {
          throw new Error("La contrase√±a debe tener al menos 8 caracteres, incluyendo may√∫sculas, min√∫sculas, n√∫meros y caracteres especiales.");
        }

        // üîê Hasheando nueva contrase√±a...
        const hashedPassword = await bcrypt.hash(newPassword, 10);

        // üìå Actualizando contrase√±a en la base de datos...
        try {
          await ctx.call("user.updatePassword", { email, password: hashedPassword });
        } catch (error) {
          throw new Error(`No se pudo actualizar la contrase√±a: ${error.message}`);
        }

        return { message: "Contrase√±a actualizada correctamente." };
      } catch (error) {
        throw new Error(error.message);
      }
    },
  },
};
